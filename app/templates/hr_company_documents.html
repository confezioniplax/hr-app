{% extends layout or "layout_manager.html" %}
{% block content %}
<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Documenti aziendali</h2>
        <div class="btn-group btn-group-sm">
            <button class="btn btn.success btn-success" data-bs-toggle="modal" data-bs-target="#docModal">
                + Aggiungi
            </button>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header fw-bold">Filtri</div>
        <div class="card-body">
            <form id="filters" class="row g-2">
                <div class="col-md-3">
                    <label class="form-label">Ricerca</label>
                    <input type="text" class="form-control" id="q" placeholder="Titolo o note…">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Anno</label>
                    <input type="number" min="2000" max="2100" class="form-control" id="year">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Frequenza</label>
                    <select class="form-select" id="frequency">
                        <option value="">Tutte</option>
                        <option value="annuale" selected>Annuale</option>
                        <option value="semestrale">Semestrale</option>
                        <option value="biennale">Biennale</option>
                        <option value="triennale">Triennale</option>
                        <option value="quadriennale">Quadriennale</option>
                        <option value="quinquennale">Quinquennale</option>
                        <option value="una_tantum">Una tantum</option>
                        <option value="variabile">Variabile</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Categoria</label>
                    <select class="form-select" id="categoryFilter">
                        <option value="">Tutte</option>
                        {% for c in categories or [] %}
                        <option value="{{ c.code }}">{{ c.label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" id="applyFilters" class="btn btn-primary w-100">Applica</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header fw-bold">Elenco documenti</div>
        <div class="card-body">
            <table class="table table-bordered table-striped w-100" id="docsTable">
                <thead>
                    <tr>
                        <th style="width:30%">Titolo</th>
                        <th style="width:10%">Anno</th>
                        <th style="width:18%">Categoria</th>
                        <th style="width:14%">Frequenza</th>
                        <th style="width:14%">File</th>
                        <th style="width:14%">Azioni</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <small class="text-muted">
                La colonna <em>File</em> mostra il nome archiviato. Il download è puntuale per riga.
            </small>
        </div>
    </div>
</div>

<!-- Modal Aggiungi/Modifica -->
<div class="modal fade" id="docModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Aggiungi/Modifica documento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="docForm" enctype="multipart/form-data">
                    <input type="hidden" name="id" id="docId">

                    <div class="row g-3">
                        <!-- 1: TITOLO -->
                        <div class="col-md-8">
                            <label class="form-label">Titolo</label>
                            <input type="text" class="form-control" name="title" id="title" required
                                placeholder="Es. Nomina addetti primo soccorso">
                        </div>

                        <!-- 2: ANNO (disabilitato finché non ho suggerimenti in creazione) -->
                        <div class="col-md-4">
                            <label class="form-label">Anno</label>
                            <input type="number" class="form-control" name="year" id="yearInput" min="2000" max="2100"
                                required disabled>
                        </div>

                        <!-- 3: FILE SUBITO DOPO TITOLO -->
                        <div class="col-md-12">
                            <label class="form-label">
                                Allegato (PDF/Immagine/Doc)
                            </label>
                            <input class="form-control" type="file" name="attachment" id="attachment"
                                accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                            <div id="currentFileHelp" class="form-text"></div>
                            <div id="suggestStatus" class="form-text text-muted">
                                Inserisci titolo e scegli un file per ottenere i suggerimenti.
                            </div>
                        </div>

                        <!-- 4: CATEGORIA / FREQUENZA (inizialmente disabled su nuovo) -->
                        <div class="col-md-4">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" name="category" id="category" disabled>
                                {% for c in categories or [] %}
                                <option value="{{ c.code }}" {% if loop.first %}selected{% endif %}>
                                    {{ c.label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Frequenza</label>
                            <select class="form-select" name="frequency" id="frequencyInput" disabled>
                                <option value="annuale" selected>Annuale</option>
                                <option value="semestrale">Semestrale</option>
                                <option value="biennale">Biennale</option>
                                <option value="triennale">Triennale</option>
                                <option value="quadriennale">Quadriennale</option>
                                <option value="quinquennale">Quinquennale</option>
                                <option value="una_tantum">Una tantum</option>
                                <option value="variabile">Variabile</option>
                            </select>
                        </div>

                        <!-- 5: NOTE (facoltative ma disabilitate finché non arriva sugg.) -->
                        <div class="col-md-12">
                            <label class="form-label">Note</label>
                            <input type="text" class="form-control" name="notes" id="notes" maxlength="255" disabled>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="saveDocBtn" class="btn btn-primary">Salva</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    (function () {
        const docModalEl = document.getElementById('docModal');

        function getDocModalInstance() {
            return bootstrap.Modal.getOrCreateInstance(docModalEl);
        }

        // ---------- helpers ----------
        function fmtFileName(path) {
            if (!path) return '';
            const parts = path.split(/[\\/]/);
            return parts[parts.length - 1] || path;
        }

        function setFormFieldsEnabled(enabled) {
            $('#yearInput').prop('disabled', !enabled);
            $('#category').prop('disabled', !enabled);
            $('#frequencyInput').prop('disabled', !enabled);
            $('#notes').prop('disabled', !enabled);
        }

        function resetForm() {
            $('#docForm')[0].reset();
            $('#docId').val('');
            $('#currentFileHelp').text('');
            $('#suggestStatus').text('Inserisci titolo e scegli un file per ottenere i suggerimenti.');
            $('#attachment').val('');
            // su NUOVO documento i campi vengono bloccati in attesa suggerimenti
            setFormFieldsEnabled(false);
        }

        function loadDocs() {
            const params = {
                q: $('#q').val() || null,
                year: $('#year').val() || null,
                frequency: $('#frequency').val() || null,
                category: $('#categoryFilter').val() || null
            };
            $.getJSON('/api/company-docs/list', params, function (list) {
                const $tb = $('#docsTable tbody').empty();
                (list || []).forEach(d => {
                    const tr = document.createElement('tr');
                    const catLabel = d.category_label || d.category || '';
                    tr.innerHTML = `
                        <td>${d.title || ''}</td>
                        <td>${d.year || ''}</td>
                        <td>${catLabel}</td>
                        <td>${(d.frequency || '').toUpperCase()}</td>
                        <td>${fmtFileName(d.file_path)}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                              <a class="btn btn-outline-secondary" href="/api/company-docs/download/${d.id}">Scarica</a>
                              <button class="btn btn-outline-primary editBtn">Modifica</button>
                              <button class="btn btn-outline-danger deleteBtn">Elimina</button>
                            </div>
                        </td>`;
                    $(tr).data('row', d);
                    $tb.append(tr);
                });
            }).fail(xhr => {
                alert('Errore nel caricamento documenti: ' + (xhr?.responseJSON?.detail || xhr?.responseText || ''));
            });
        }

        function openModalForNew() {
            resetForm();
            const modal = getDocModalInstance();
            modal.show();
        }

        function openModalForEdit(row) {
            resetForm();
            $('#docId').val(row.id || '');
            $('#title').val(row.title || '');
            $('#yearInput').val(row.year || '');
            $('#category').val(row.category_code || row.category || $('#category option:first').val());
            $('#frequencyInput').val(row.frequency || 'annuale');
            $('#notes').val(row.notes || '');
            $('#currentFileHelp').text(row.file_path
                ? ('File attuale: ' + fmtFileName(row.file_path))
                : 'Nessun file caricato');

            // in MODIFICA i campi devono essere sempre editabili subito
            setFormFieldsEnabled(true);
            $('#suggestStatus').text('Puoi modificare i campi o caricare un nuovo file.');

            const modal = getDocModalInstance();
            modal.show();
        }

        function applySuggestions(data) {
            if (!data) data = {};
            if (data.year) {
                $('#yearInput').val(data.year);
            }
            if (data.category) {
                $('#category').val(data.category);
            }
            if (data.frequency) {
                $('#frequencyInput').val(data.frequency);
            }
            // Una volta arrivati i suggerimenti, abilito sempre i campi
            setFormFieldsEnabled(true);
        }

        function requestSuggestionsIfReady() {
            const title = ($('#title').val() || '').trim();
            const fileInput = document.getElementById('attachment');
            const file = fileInput && fileInput.files && fileInput.files[0];

            if (!title || !file) {
                return;
            }

            $('#suggestStatus').text('Calcolo suggerimenti dal file…');
            setFormFieldsEnabled(false);

            const fd = new FormData();
            fd.append('title', title);
            fd.append('attachment', file);

            $.ajax({
                url: '/api/company-docs/suggest-metadata',
                method: 'POST',
                processData: false,
                contentType: false,
                data: fd
            })
                .done(function (resp) {
                    applySuggestions(resp || {});
                    $('#suggestStatus').text('Suggerimenti compilati automaticamente. Verifica e modifica se necessario.');
                })
                .fail(function (xhr) {
                    $('#suggestStatus').text('Suggerimenti non disponibili. Compila i campi manualmente.');
                    // in errore li sblocco comunque
                    setFormFieldsEnabled(true);
                });
        }

        // ---------- events ----------
        $('#applyFilters').on('click', loadDocs);

        // Apertura modale da bottone "+ Aggiungi"
        docModalEl.addEventListener('show.bs.modal', function (e) {
            if (e.relatedTarget && e.relatedTarget.matches('button')) {
                // nuovo documento
                openModalForNew();
            }
        });

        $('#docsTable').on('click', '.editBtn', function () {
            const row = $(this).closest('tr').data('row');
            if (!row) return;
            openModalForEdit(row);
        });

        $('#docsTable').on('click', '.deleteBtn', function () {
            const row = $(this).closest('tr').data('row');
            if (!row?.id) return;
            if (!confirm('Eliminare questo documento?')) return;
            $.post('/api/company-docs/delete', { id: row.id })
                .done(loadDocs)
                .fail(xhr => alert('Errore eliminazione: ' + (xhr?.responseJSON?.detail || xhr?.responseText || '')));
        });

        // Suggerimenti: trigger quando selezioni file e quando finisci di scrivere il titolo
        $('#attachment').on('change', function () {
            $('#currentFileHelp').text(this.files && this.files[0] ? 'File selezionato: ' + this.files[0].name : '');
            requestSuggestionsIfReady();
        });

        $('#title').on('blur', function () {
            requestSuggestionsIfReady();
        });

        $('#saveDocBtn').on('click', function () {
            const fd = new FormData(document.getElementById('docForm'));
            if (!$('#docId').val()) fd.delete('id');  // se nuovo, non mandare id vuoto

            $('#saveDocBtn').prop('disabled', true);
            $.ajax({
                url: '/api/company-docs/upsert',
                method: 'POST',
                processData: false,
                contentType: false,
                data: fd
            })
                .done(function () {
                    getDocModalInstance().hide();
                    loadDocs();
                })
                .fail(function (xhr) {
                    alert('Errore salvataggio: ' + (xhr?.responseJSON?.detail || xhr?.responseText || ''));
                })
                .always(function () {
                    $('#saveDocBtn').prop('disabled', false);
                });
        });

        // init
        loadDocs();
    })();
</script>
{% endblock %}