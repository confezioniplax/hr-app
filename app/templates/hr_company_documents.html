{% extends layout or "layout_manager.html" %}
{% block content %}
<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Documenti aziendali — Sicurezza</h2>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#docModal">
                + Aggiungi
            </button>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header fw-bold">Filtri</div>
        <div class="card-body">
            <form id="filters" class="row g-2">
                <div class="col-md-4">
                    <label class="form-label">Ricerca</label>
                    <input type="text" class="form-control" id="q" placeholder="Titolo o note…">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Anno</label>
                    <input type="number" min="2000" max="2100" class="form-control" id="year">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Frequenza</label>
                    <select class="form-select" id="frequency">
                        <option value="">Tutte</option>
                        <option value="annuale">Annuale</option>
                        <option value="semestrale">Semestrale</option>
                        <option value="triennale">Triennale</option>
                        <option value="una_tantum">Una tantum</option>
                        <option value="variabile">Variabile</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" id="applyFilters" class="btn btn-primary w-100">Applica</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header fw-bold">Elenco documenti</div>
        <div class="card-body">
            <table class="table table-bordered table-striped w-100" id="docsTable">
                <thead>
                    <tr>
                        <th style="width:38%">Titolo</th>
                        <th style="width:10%">Anno</th>
                        <th style="width:18%">Frequenza</th>
                        <th style="width:18%">File</th>
                        <th style="width:16%">Azioni</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <small class="text-muted">
                La colonna <em>File</em> mostra il nome archiviato. In caso di più versioni, compaiono più righe; il
                download è sempre puntuale per riga.
            </small>
        </div>
    </div>
</div>

<!-- Modal Aggiungi/Modifica -->
<div class="modal fade" id="docModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Aggiungi/Modifica documento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="docForm" enctype="multipart/form-data">
                    <input type="hidden" name="id" id="docId">

                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Titolo</label>
                            <input type="text" class="form-control" name="title" id="title" required
                                placeholder="Es. Verbale riunione periodica art. 35">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Anno</label>
                            <input type="number" class="form-control" name="year" id="yearInput" min="2000" max="2100"
                                required>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" name="category" id="category">
                                <option value="Sicurezza" selected>Sicurezza</option>
                                <option value="Qualità">Qualità</option>
                                <option value="HR">HR</option>
                                <option value="Ambiente">Ambiente</option>
                                <option value="Produzione">Produzione</option>
                                <option value="Altro">Altro</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Frequenza</label>
                            <select class="form-select" name="frequency" id="frequencyInput">
                                <option value="annuale" selected>Annuale</option>
                                <option value="semestrale">Semestrale</option>
                                <option value="triennale">Triennale</option>
                                <option value="una_tantum">Una tantum</option>
                                <option value="variabile">Variabile</option>
                            </select>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Note</label>
                            <input type="text" class="form-control" name="notes" id="notes" maxlength="255">
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Allegato (PDF/Immagine/Doc) <small class="text-muted">(opzionale
                                    in modifica)</small></label>
                            <input class="form-control" type="file" name="attachment" id="attachment"
                                accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                            <div id="currentFileHelp" class="form-text"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="saveDocBtn" class="btn btn-primary">Salva</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    (function () {
        // ---------- helpers ----------
        function fmtFileName(path) {
            if (!path) return '';
            const parts = path.split(/[\\/]/);
            return parts[parts.length - 1] || path;
        }

        function loadDocs() {
            const params = {
                q: $('#q').val() || null,
                year: $('#year').val() || null,
                frequency: $('#frequency').val() || null,
            };
            $.getJSON('/api/company-docs/list', params, function (list) {
                const $tb = $('#docsTable tbody').empty();
                (list || []).forEach(d => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
          <td>${d.title || ''}</td>
          <td>${d.year || ''}</td>
          <td>${(d.frequency || '').toUpperCase()}</td>
          <td>${fmtFileName(d.file_path)}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <a class="btn btn-outline-secondary" href="/api/company-docs/download/${d.id}">Scarica</a>
              <button class="btn btn-outline-primary editBtn">Modifica</button>
              <button class="btn btn-outline-danger deleteBtn">Elimina</button>
            </div>
          </td>`;
                    $(tr).data('row', d);
                    $('#docsTable tbody').append(tr);
                });
            }).fail(xhr => {
                alert('Errore nel caricamento documenti: ' + (xhr?.responseJSON?.detail || xhr?.responseText || ''));
            });
        }

        function openModalForNew() {
            $('#docForm')[0].reset();
            $('#docId').val('');
            $('#currentFileHelp').text('');
            $('#docModal').modal('show');
        }

        function openModalForEdit(row) {
            $('#docForm')[0].reset();
            $('#docId').val(row.id || '');
            $('#title').val(row.title || '');
            $('#yearInput').val(row.year || '');
            $('#category').val(row.category || 'Sicurezza');
            $('#frequencyInput').val(row.frequency || 'annuale');
            $('#notes').val(row.notes || '');
            $('#attachment').val('');
            $('#currentFileHelp').text(row.file_path ? ('File attuale: ' + fmtFileName(row.file_path)) : 'Nessun file caricato');
            $('#docModal').modal('show');
        }

        // ---------- events ----------
        $('#applyFilters').on('click', loadDocs);

        $('#docModal').on('show.bs.modal', function (e) {
            // se aperto da "+ Aggiungi", pulisci i campi
            if ($(e.relatedTarget).is('button')) openModalForNew();
        });

        $('#docsTable').on('click', '.editBtn', function () {
            const row = $(this).closest('tr').data('row');
            if (!row) return;
            openModalForEdit(row);
        });

        $('#docsTable').on('click', '.deleteBtn', function () {
            const row = $(this).closest('tr').data('row');
            if (!row?.id) return;
            if (!confirm('Eliminare questo documento?')) return;
            $.post('/api/company-docs/delete', { id: row.id })
                .done(loadDocs)
                .fail(xhr => alert('Errore eliminazione: ' + (xhr?.responseJSON?.detail || xhr?.responseText || '')));
        });

        $('#saveDocBtn').on('click', function () {
            const fd = new FormData(document.getElementById('docForm'));
            // se id è vuoto, evitare di mandare un campo vuoto a volte più comodo:
            if (!$('#docId').val()) fd.delete('id');

            $('#saveDocBtn').prop('disabled', true);
            $.ajax({
                url: '/api/company-docs/upsert',
                method: 'POST',
                processData: false,
                contentType: false,
                data: fd
            })
                .done(function () {
                    $('#docModal').modal('hide');
                    loadDocs();
                })
                .fail(function (xhr) {
                    alert('Errore salvataggio: ' + (xhr?.responseJSON?.detail || xhr?.responseText || ''));
                })
                .always(function () {
                    $('#saveDocBtn').prop('disabled', false);
                });
        });

        // init
        loadDocs();
    })();
</script>
{% endblock %}