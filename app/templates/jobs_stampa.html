{% extends "layout_manager.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0">Report Produzione — <span class="text-primary">STAMPA</span></h2>
            <div class="small text-muted">Mod. 021 S</div>
        </div>
        <div id="shiftBadge" class="badge bg-secondary"></div>
        <div class="d-flex gap-2">
            <a href="/home-operators" class="btn btn-outline-secondary">
                ← Torna alla Home
            </a>
        </div>
    </div>

    <!-- FILTRI -->
    <form id="jobsFilterForm" class="mb-3" action="/jobs/stampa" method="get">
        <div class="row g-2">
            <div class="col-12 col-md-3">
                <label class="form-label">Data</label>
                <input type="date" id="filterDate" name="date" class="form-control" value="{{ selected_date or '' }}"
                    required />
            </div>
            <div class="col-12 col-md-5">
                <label class="form-label">Macchina (reparto: STAMPA)</label>
                <select id="filterMachine" name="machine_id" class="form-select">
                    <option value="">Tutte le macchine di Stampa…</option>
                    {% for m in machines %}
                    <option value="{{ m.id }}" {% if selected_machine and selected_machine==m.id %}selected{% endif %}>
                        [{{ m.code }}] {{ m.name or '' }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">Mostra</button>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newJobModal">
                    Nuova riga
                </button>
            </div>
        </div>
    </form>

    <!-- TABELLA: aderente alla scansione -->
    <table id="jobsTable" class="table table-bordered display w-100">
        <thead class="thead-light">
            <tr>
                <th>ID</th>
                <th>Macchina</th>
                <th>Avviamento (dalle–alle)</th>
                <th>Produzione (dalle–alle)</th>
                <th>Lotto</th>
                <th>Cliente/Soggetto</th>
                <th>Colori</th>
                <th>Lato</th>
                <th>MT Avv.</th>
                <th>MT Prodotti</th>
                <th>Bonifica</th>
                <th>Punti luce/monitor</th>
                <th>Note</th>
                <th>Azioni</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- MODALE NUOVA RIGA — STAMPA -->
<div class="modal fade" id="newJobModal" tabindex="-1" aria-labelledby="newJobLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="newJobLabel" class="modal-title">Nuova riga — STAMPA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body">
                <form id="newJobForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Data</label>
                            <input type="date" name="job_date" class="form-control" value="{{ selected_date or '' }}"
                                required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Processo</label>
                            <input type="text" class="form-control" value="STAMPA" readonly>
                            <input type="hidden" name="process_type" value="STAMPA">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Macchina (STAMPA)</label>
                            <select name="machine_id" class="form-select" required id="machineSelectModal">
                                <option value="">Seleziona…</option>
                            </select>
                        </div>

                        <!-- Operatori -->
                        <div class="col-md-6">
                            <label class="form-label">Operatore</label>
                            <select id="operatorMainSelect" class="form-select" required>
                                <option value="">Seleziona operatore…</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Operatore aggiuntivo (opz.)</label>
                            <select id="operatorExtraSelect" class="form-select" multiple></select>
                        </div>

                        <!-- AVVIAMENTO -->
                        <div class="col-12">
                            <div class="border rounded p-2 bg-light">
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <label class="form-label">AVVIAMENTO — dalle</label>
                                        <input type="time" class="form-control" id="oraAvvDalle">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">AVVIAMENTO — alle</label>
                                        <input type="time" class="form-control" id="oraAvvAlle">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">MT Avviamento</label>
                                        <input type="number" step="0.01" name="mt_startup" id="mt_startup"
                                            class="form-control">
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <small class="text-muted">Scarto base avviamento: 30 m</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PRODUZIONE -->
                        <div class="col-md-3">
                            <label class="form-label">Produzione — dalle</label>
                            <input type="time" name="start_time" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Produzione — alle</label>
                            <input type="time" name="end_time" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Lotto</label>
                            <input type="text" name="lot_code" class="form-control" placeholder="es. 25-OC1589-1"
                                required>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Cliente / Soggetto</label>
                            <input type="text" name="client_name" class="form-control" placeholder="Cliente" required>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">N° colori</label>
                            <input type="number" class="form-control" id="numColori" min="1">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Lato stampa</label>
                            <select class="form-select" id="latoStampa">
                                <option value="">—</option>
                                <option value="INT">INT</option>
                                <option value="EST">EST</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">MT Prodotti</label>
                            <input type="number" name="meters_produced" class="form-control" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Scarto (m)</label>
                            <input type="number" step="0.01" name="scrap_m" id="scrap_m" class="form-control">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Bonifica linea</label>
                            <select class="form-select qc-field" data-qc-code="BONIFICA_LINEA">
                                <option value="">—</option>
                                <option value="OK">OK</option>
                                <option value="KO">KO</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Controllo punti luce / monitor</label>
                            <select class="form-select qc-field" data-qc-code="PUNTI_LUCE_BORDO">
                                <option value="">—</option>
                                <option value="OK">OK</option>
                                <option value="KO">KO</option>
                            </select>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Note (cause eccesso scarto / fermi macchina)</label>
                            <textarea name="notes" class="form-control" rows="2" placeholder="Note"></textarea>
                        </div>
                    </div>

                    <!-- HIDDEN PAYLOADS -->
                    <input type="hidden" name="operator_ids" id="operatorIdsHidden">
                    <input type="hidden" name="quality_checks" id="qcHidden">
                    <input type="hidden" name="materials" id="materialsHidden">
                    <input type="hidden" name="consumables" id="consumablesHidden">
                    <input type="hidden" name="events" id="eventsHidden">
                    <input type="hidden" name="properties" id="propsHidden">
                    <input type="hidden" name="shift_label" id="shiftField">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="saveJobBtn" class="btn btn-primary">Salva</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script>
    $(function () {
        // ===== TABELLA GIORNO =====
        var data = {{ data | tojson | safe
    }}; data = data ? JSON.parse(data) : [];
    var table = $('#jobsTable').DataTable({
        data: data,
        columns: [
            { data: null, title: 'ID', render: d => (d.id ?? d.job_id) },
            { data: null, title: 'Macchina', render: d => `[${d.machine_code}] ${d.machine_name || ''}` },
            { data: null, title: 'Avv.', render: d => (d.avv_start && d.avv_end) ? `${d.avv_start}–${d.avv_end}` : '' },
            { data: null, title: 'Prod.', render: d => (d.start_time && d.end_time) ? `${d.start_time}–${d.end_time}` : '' },
            { data: 'lot_code', title: 'Lotto', defaultContent: '' },
            { data: 'client_name', title: 'Cliente/Soggetto', defaultContent: '' },
            { data: 'num_colori', title: 'Colori', defaultContent: '' },
            { data: 'lato_stampa', title: 'Lato', defaultContent: '' },
            { data: 'setup_meters', title: 'MT Avv.', defaultContent: '' },
            { data: 'meters_produced', title: 'MT Prodotti', defaultContent: '' },
            { data: 'qc_bonifica', title: 'Bonifica', defaultContent: '' },
            { data: 'qc_puntoluce', title: 'Punti luce/monitor', defaultContent: '' },
            { data: 'notes', title: 'Note', render: d => d ? (d.length > 30 ? d.substring(0, 30) + '…' : d) : '' },
            { data: null, title: 'Azioni', defaultContent: `<button class="btn btn-info btn-sm viewBtn">Dettaglio</button>` }
        ]
    });
    $('#jobsTable tbody').on('click', 'button.viewBtn', function () {
        const row = table.row($(this).parents('tr')).data();
        const jid = row.id ?? row.job_id;
        if (!jid) return alert('ID job non presente');
        window.location.href = '/jobs/detail/' + jid;
    });

    // ===== META: MACCHINE & OPERATORI STAMPA =====
    const DEPT_STAMPA = 1;

    function loadMachinesStampa() {
        $.getJSON('/api/jobs/meta/machines', function (list) {
            var $sel = $('#machineSelectModal').empty().append('<option value="">Seleziona…</option>');
            list.filter(m => (m.department_id ? Number(m.department_id) === DEPT_STAMPA : true))
                .forEach(function (m) {
                    $sel.append(`<option value="${m.id}">[${m.code}] ${m.name || ''}</option>`);
                });
            const current = $('#filterMachine').val();
            if (current) $sel.val(current);
        });
    }

    function loadOperatorsStampa() {
        $.getJSON('/api/jobs/meta/operators?department_id=' + DEPT_STAMPA, function (list) {
            const $main = $('#operatorMainSelect').empty().append('<option value="">Seleziona operatore…</option>');
            const $extra = $('#operatorExtraSelect').empty();
            list.forEach(function (o) {
                const label = `${o.last_name} ${o.first_name}`;
                $main.append(`<option value="${o.id}">${label}</option>`);
                $extra.append(`<option value="${o.id}">${label}</option>`);
            });
        });
    }

    $('#newJobModal').on('show.bs.modal', function () {
        loadMachinesStampa();
        loadOperatorsStampa();
        // reset hidden
        $('#operatorIdsHidden,#qcHidden,#materialsHidden,#consumablesHidden,#eventsHidden,#propsHidden').val('');
        $('#shiftField').val('');
        $('#oraAvvDalle, #oraAvvAlle, #mt_startup').val('');
    });

    // ===== UTIL =====
    function numOrNull(v) { if (v === undefined || v === null || v === '') return null; const n = Number(v); return isNaN(n) ? null : n; }
    function determineShiftFromTime(hhmm) {
        if (!hhmm || !/^\d{2}:\d{2}$/.test(hhmm)) return '';
        const h = parseInt(hhmm.split(':')[0], 10);
        if (h >= 6 && h < 14) return 'MATTINA';
        if (h >= 14 && h < 21) return 'POMERIGGIO';
        return 'SERA';
    }

    function updateShiftBadge() {
        const start = document.querySelector('#newJobForm input[name="start_time"]').value || '';
        const shift = determineShiftFromTime(start);
        $('#shiftField').val(shift);
        $('#shiftBadge').text(shift || '');
        $('#shiftBadge').toggleClass('bg-secondary', !shift).toggleClass('bg-info', !!shift);
    }

    document.addEventListener('input', function (e) {
        if (e.target && e.target.name === 'start_time') updateShiftBadge();
    });

    // ===== SALVATAGGIO =====
    $('#saveJobBtn').on('click', function () {
        // operatori: principale + extra
        const mainOp = $('#operatorMainSelect').val();
        const extras = $('#operatorExtraSelect').val() || [];
        const set = new Set(); if (mainOp) set.add(mainOp); extras.forEach(x => set.add(x));
        $('#operatorIdsHidden').val(JSON.stringify(Array.from(set)));

        // QC Stampa
        const qc = [];
        const bon = $('select[data-qc-code="BONIFICA_LINEA"]').val();
        const pl = $('select[data-qc-code="PUNTI_LUCE_BORDO"]').val();
        if (bon) qc.push({ check_type_code: 'BONIFICA_LINEA', result: bon });
        if (pl) qc.push({ check_type_code: 'PUNTI_LUCE_BORDO', result: pl });
        $('#qcHidden').val(JSON.stringify(qc));

        // Nessun materiale/consumabili/eventi specifici qui
        $('#materialsHidden').val(JSON.stringify([]));
        $('#consumablesHidden').val(JSON.stringify([]));
        $('#eventsHidden').val(JSON.stringify([]));

        // Proprietà: AVVIAMENTO + parametri stampa
        const props = [];
        const avvDalle = $('#oraAvvDalle').val() || null;
        const avvAlle = $('#oraAvvAlle').val() || null;
        const ncol = numOrNull($('#numColori').val());
        const lato = $('#latoStampa').val() || null;

        if (avvDalle) props.push({ prop_key: 'ORA_AVVIAMENTO_DALLE', prop_value: avvDalle });
        if (avvAlle) props.push({ prop_key: 'ORA_AVVIAMENTO_ALLE', prop_value: avvAlle });
        if (ncol !== null) props.push({ prop_key: 'NUMERO_COLORI', prop_value: String(ncol) });
        if (lato) props.push({ prop_key: 'LATO_STAMPA', prop_value: lato });

        // anche un duplicato per la tabella (facilita la view)
        // avv_start/avv_end li potrai valorizzare lato API nella query, ma lascio qui in props per coerenza DB
        $('#propsHidden').val(JSON.stringify(props));

        // turno da start_time
        updateShiftBadge();

        // POST
        $.ajax({
            type: 'POST',
            url: '/api/jobs/create',
            data: $('#newJobForm').serialize(),
            success: function (resp) {
                alert('Riga creata (ID: ' + resp.job_id + ')');
                $('#newJobModal').modal('hide');

                // ricostruisco l’URL evitando machine_id vuoto
                const d = $('#filterDate').val() || '';
                const mid = $('#filterMachine').val();
                let url = window.location.pathname + '?date=' + encodeURIComponent(d);
                if (mid && String(mid).trim() !== '') {
                    url += '&machine_id=' + encodeURIComponent(mid);
                }
                window.location.href = url;
            },

            error: function (err) {
                console.error(err);
                alert('Errore creazione riga');
            }
        });
    });
});
</script>
{% endblock %}