{% extends layout or "layout_manager.html" %}
{% block content %}
<div class="container-fluid mt-4" data-operator-id="{{ operator_id }}">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Scheda Operatore #{{ operator_id }}</h2>
        <a href="/hr/certificazioni" class="btn btn-outline-secondary">← Torna</a>
    </div>

    <div class="card mb-3">
        <div class="card-header fw-bold">Anagrafica</div>
        <div class="card-body">
            <form id="anagForm" class="row g-3">
                <input type="hidden" name="id" id="op_id" value="{{ operator_id }}">

                <div class="col-md-3">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-control" name="first_name" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Cognome</label>
                    <input type="text" class="form-control" name="last_name" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">CF</label>
                    <input type="text" class="form-control" name="fiscal_code">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Telefono</label>
                    <input type="text" class="form-control" name="phone">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" name="email">
                </div>
                <div class="col-md-5">
                    <label class="form-label">Residenza</label>
                    <input type="text" class="form-control" name="address" placeholder="via/piazza, n°, città">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Data di nascita</label>
                    <input type="date" class="form-control" name="birth_date">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Cittadinanza</label>
                    <input type="text" class="form-control" name="citizenship" placeholder="es. Italiana, Rumena">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Titolo di studio</label>
                    <input list="educationOptions" class="form-control" name="education_level"
                        placeholder="es. Diploma, Laurea…">
                    <datalist id="educationOptions">
                        <option value="Nessuno">
                        <option value="Licenza media">
                        <option value="Diploma">
                        <option value="Laurea triennale">
                        <option value="Laurea magistrale">
                        <option value="Master">
                        <option value="Dottorato">
                        <option value="Altro">
                    </datalist>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Assunzione</label>
                    <input type="date" class="form-control" name="hire_date">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Tipo contratto</label>
                    <input type="text" class="form-control" name="contract_type">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Scadenza contr.</label>
                    <input type="date" class="form-control" name="contract_expiry">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Livello</label>
                    <input type="text" class="form-control" name="level" placeholder="es. 4, 4S, Q">
                </div>
                <div class="col-md-2">
                    <label class="form-label">RAL (€)</label>
                    <input type="text" class="form-control" name="ral" placeholder="es. 35.500,00">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Reparti</label>
                    <input type="text" class="form-control" name="departments" placeholder="es. Stampa; Taglio">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Stato</label>
                    <select class="form-select" name="active">
                        <option value="1">Attivo</option>
                        <option value="0">Non attivo</option>
                    </select>
                </div>

                <div class="col-12">
                    <button type="button" id="saveAnagBtn" class="btn btn-primary">Salva anagrafica</button>
                    <span id="saveAnagFeedback" class="text-muted ms-2"></span>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">Certificazioni</span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#editCertModal">+
                    Aggiungi</button>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newCertTypeModal">+
                    Nuovo tipo</button>
            </div>
        </div>
        <div class="card-body">
            <table id="certsTable" class="table table-bordered w-100">
                <thead>
                    <tr>
                        <th>Cert.</th>
                        <th>Stato</th>
                        <th>Rilascio</th>
                        <th>Scadenza</th>
                        <th>Giorni</th>
                        <th>Note</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <small class="text-muted">Legenda:
                <span class="badge bg-success">OK</span>
                <span class="badge bg-warning text-dark">IN_SCADENZA_30/60/90</span>
                <span class="badge bg-danger">SCADUTA</span>
                <span class="badge bg-secondary">MANCA</span>
                <span class="badge bg-dark">ND</span>
            </small>
        </div>
    </div>
</div>

<!-- Modale Certificazioni -->
<div class="modal fade" id="editCertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Aggiungi/Modifica certificazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCertForm" enctype="multipart/form-data">
                    <input type="hidden" name="id" id="certRowId">
                    <input type="hidden" name="operator_id" id="certOperatorId" value="{{ operator_id }}">
                    <div class="mb-2">
                        <label class="form-label">Tipo certificazione</label>
                        <select class="form-select" name="cert_type_id" id="certTypeSelect" required>
                            <option value="">Seleziona…</option>
                        </select>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Stato</label>
                            <select class="form-select" name="status" required>
                                <option value="OK">OK</option>
                                <option value="MANCA">MANCA</option>
                                <option value="ND">ND</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Rilascio</label>
                            <input type="date" class="form-control" name="issue_date">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Scadenza</label>
                            <input type="date" class="form-control" name="expiry_date">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Note</label>
                            <input type="text" class="form-control" name="notes" maxlength="255">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Allegato (PDF/immagine/Word)</label>
                            <input type="file" class="form-control" name="attachment" id="certAttachment"
                                accept=".pdf,image/*,.doc,.docx,.odt">
                            <small class="text-muted">Verrà salvato in
                                \\Certificazioni\\&lt;CF&gt;\\&lt;TIPO&gt;_&lt;DATA&gt;.&lt;ext&gt;</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <small class="text-muted" id="currentFileInfo"></small>
                <button type="button" id="saveCertBtn" class="btn btn-primary">Salva</button>
            </div>
        </div>
    </div>
</div>

<!-- Modale: Nuovo tipo di certificazione -->
<div class="modal fade" id="newCertTypeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nuovo tipo di certificazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newCertTypeForm">
                    <div class="mb-2">
                        <label class="form-label">Codice</label>
                        <input name="code" class="form-control" placeholder="es. CARRELLO" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Descrizione</label>
                        <input name="description" class="form-control" placeholder="es. Patentino muletto">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Richiede scadenza?</label>
                        <select name="requires_expiry" class="form-select">
                            <option value="1" selected>Sì</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="createCertTypeBtn" type="button" class="btn btn-primary">Crea</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    (function () {
        const opId = document.querySelector('[data-operator-id]').getAttribute('data-operator-id');

        // ----------------- Utilities -----------------
        function daysTo(dateStr) {
            if (!dateStr) return '';
            const t = new Date(); t.setHours(0, 0, 0, 0);
            const d = new Date(dateStr + 'T00:00:00');
            return Math.round((d - t) / (1000 * 60 * 60 * 24));
        }
        function badge(st) {
            const m = {
                OK: 'success',
                'IN_SCADENZA_30': 'warning',
                'IN_SCADENZA_60': 'warning',
                'IN_SCADENZA_90': 'warning',
                SCADUTA: 'danger',
                MANCA: 'secondary',
                ND: 'dark'
            };
            return st ? `<span class="badge bg-${m[st] || 'secondary'}">${st}</span>` : '';
        }
        function getParam(name) {
            const u = new URL(window.location.href);
            return u.searchParams.get(name);
        }
        function fmtISO(d) {
            const y = d.getFullYear(),
                m = String(d.getMonth() + 1).padStart(2, '0'),
                da = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${da}`;
        }
        function addYears(base, y) {
            const d = new Date(base.getTime());
            d.setFullYear(d.getFullYear() + y);
            return d;
        }

        // ----------------- Regole scadenza -----------------
        /**
         * Calcola scadenza in base al testo del tipo certificazione (certText),
         * alla data di rilascio (issueStr, YYYY-MM-DD) e alla data di nascita (birthStr) dell’operatore.
         * Regole:
         *  - DIISOCIANATI → 5 anni
         *  - VISITA MEDICA reparti: STAMPA / ACCOPPIAMENTO / TAGLIO / SALDATURA / MAGAZZINO → annuale
         *  - VISITA MEDICA UFFICIO/UFFICI → 5 anni (2 anni se età > 50 al rilascio)
         */
        function computeExpiry(certText, issueStr, birthStr) {
            if (!issueStr) return null;

            const t = (certText || '').trim().toUpperCase();
            const issue = new Date(issueStr + 'T00:00:00');

            // DIISOCIANATI → 5 anni
            if (/DIISOCIANATI/.test(t)) {
                return addYears(issue, 5);
            }

            // VISITA MEDICA reparti produttivi + MAGAZZINO → annuale
            if (/VISITA[\s\S]*MEDICA/.test(t) &&
                /(STAMPA|ACCOPPIAMENTO|TAGLIO|SALDATURA|MAGAZZINO)/.test(t)) {
                return addYears(issue, 1);
            }

            // VISITA MEDICA UFFICIO/UFFICI → 5 anni, ma biennale se >50 anni
            if (/VISITA[\s\S]*MEDICA/.test(t) && /UFFICIO(I)?/.test(t)) {
                if (birthStr) {
                    const birth = new Date(birthStr + 'T00:00:00');
                    const ageAtIssue =
                        issue.getFullYear() - birth.getFullYear() -
                        (
                            issue.getMonth() < birth.getMonth() ||
                                (
                                    issue.getMonth() === birth.getMonth() &&
                                    issue.getDate() < birth.getDate()
                                )
                                ? 1
                                : 0
                        );
                    return addYears(issue, ageAtIssue >= 50 ? 2 : 5);
                }
                return addYears(issue, 5);
            }


            // ADDETTI AI PONTEGGI → 4 anni
            if (/PONTEGGI/.test(t)) {
                return addYears(issue, 4);
            }

            // PRIMO SOCCORSO / PRIMO_SOCCORSO → 3 anni
            if (/PRIMO.*SOCCORSO/.test(t) || /PRIMO_SOCCORSO/.test(t)) {
                return addYears(issue, 3);
            }

            // ANTINCENDIO MEDIO RISCHIO / ANTINCENDIO → 5 anni
            if (/ANTINCENDIO.*MEDIO/.test(t) || /^ANTINCENDIO\b/.test(t)) {
                return addYears(issue, 5);
            }

            // RLS → 1 anno
            if (/^RLS\b/.test(t)) {
                return addYears(issue, 1);
            }

            // PREPOSTI → 5 anni
            if (/PREPOSTI/.test(t)) {
                return addYears(issue, 5);
            }

            // ADDETTI MACCHINE DI CANTIERE / CARRELLI_ELEV → 5 anni
            if (/MACCHINE.*CANTIERE/.test(t) || /CARRELLI[_ ]?ELEV/.test(t)) {
                return addYears(issue, 5);
            }

            // RSPP → 1 anno
            if (/^RSPP\b/.test(t)) {
                return addYears(issue, 1);
            }

            // COORDINATORI → 5 anni
            if (/COORDINATORI/.test(t)) {
                return addYears(issue, 5);
            }

            // Formazione sicurezza generale / specifica → 5 anni
            if (/SICUREZZA[_ ]?SPEC/.test(t) || /SICUREZZA.*SPECIFICA/.test(t)) {
                return addYears(issue, 5);
            }

            // fallback: nessuna regola → nessuna scadenza
            return null;
        }

        // ----------------- Load tipi certificazione -----------------
        function loadCertTypes(selectedId) {
            // ritorna una Promise per permettere .then(...)
            return $.getJSON('/api/hr/meta/cert-types', function (list) {
                const $sel = $('#certTypeSelect').empty().append('<option value="">Seleziona…</option>');
                list.forEach(c => $sel.append(`<option value="${c.id}">${c.code}</option>`));
                if (selectedId != null && selectedId !== '') {
                    $sel.val(String(selectedId));
                }
            });
        }

        // ----------------- Autofill scadenza -----------------
        function tryAutofillExpiry() {
            const certTypeText = $('#certTypeSelect option:selected').text() || '';
            const operatorDepartments = $('input[name="departments"]').val() || ''; // es. "Stampa; Taglio"

            // testo complessivo su cui lavorano le regex (certificato + reparti operatore)
            const certText = (certTypeText + ' ' + operatorDepartments);

            const issue = $('#editCertForm [name="issue_date"]').val();
            const operatorBirth = $('input[name="birth_date"]').val(); // dall’anagrafica caricata nel form
            const auto = computeExpiry(certText, issue, operatorBirth);
            if (auto) {
                const $exp = $('#editCertForm [name="expiry_date"]');
                // sovrascrivi solo se non toccata manualmente dopo ultimo cambio tipo/rilascio
                if (!$exp.data('touched')) {
                    $exp.val(fmtISO(auto));
                }
            }
        }

        // L’utente ha toccato manualmente la scadenza → non sovrascrivere più finché non cambia tipo/rilascio
        $('#editCertForm [name="expiry_date"]').on('input change', function () {
            $(this).data('touched', true);
        });

        function resetExpiryTouchedAndRecompute() {
            const $exp = $('#editCertForm [name="expiry_date"]');
            $exp.data('touched', false);
            tryAutofillExpiry();
        }

        // ----------------- Anagrafica -----------------
        function loadOperator() {
            $.getJSON(`/api/hr/operators/${opId}`, function (op) {
                $('#op_id').val(op.id);
                $('input[name="first_name"]').val(op.first_name || '');
                $('input[name="last_name"]').val(op.last_name || '');
                $('input[name="fiscal_code"]').val(op.fiscal_code || '');
                $('input[name="phone"]').val(op.phone || '');
                $('input[name="email"]').val(op.email || '');
                $('input[name="address"]').val(op.address || '');
                $('input[name="birth_date"]').val(op.birth_date || '');
                $('input[name="citizenship"]').val(op.citizenship || '');
                $('input[name="education_level"]').val(op.education_level || '');
                $('input[name="hire_date"]').val(op.hire_date || '');
                $('input[name="contract_type"]').val(op.contract_type || '');
                $('input[name="contract_expiry"]').val(op.contract_expiry || '');
                $('input[name="level"]').val(op.level || '');
                $('input[name="ral"]').val(op.ral ?? '');
                $('input[name="departments"]').val(op.departments || '');
                $('select[name="active"]').val(op.active ? '1' : '0');
            }).fail(() => alert('Errore nel caricamento anagrafica'));
        }

        $('#saveAnagBtn').on('click', function () {
            const form = $('#anagForm').serialize();
            $('#saveAnagBtn').prop('disabled', true);
            $.post('/api/hr/operators/update', form)
                .done(() => $('#saveAnagFeedback').text('Salvato ✔️').fadeIn().delay(1200).fadeOut())
                .fail((xhr) => alert('Errore salvataggio anagrafica: ' + (xhr?.responseJSON?.detail || xhr?.responseText || '')))
                .always(() => $('#saveAnagBtn').prop('disabled', false));
        });

        // ----------------- Lista certificazioni -----------------
        function loadCerts() {
            $.getJSON('/api/hr/certs/status', { operator_id: Number(opId) }, function (list) {
                const $tb = $('#certsTable tbody').empty();
                list.forEach(d => {
                    const hasFile = !!d.file_path;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
          <td>${d.cert_code || ''}</td>
          <td>${badge(d.status_calc)}</td>
          <td>${d.issue_date || ''}</td>
          <td>${d.expiry_date || ''}</td>
          <td>${d.expiry_date ? daysTo(d.expiry_date) : ''}</td>
          <td>${d.notes ? (d.notes.length > 40 ? d.notes.substring(0, 40) + '…' : d.notes) : ''}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary editCertBtn">Modifica</button>
              <button class="btn btn-outline-danger deleteCertBtn">Elimina</button>
              ${hasFile ? `<a class="btn btn-outline-secondary" href="/api/hr/certs/download/${d.id}" target="_blank">Scarica</a>` : ''}
            </div>
          </td>`;
                    $(tr).data('row', {
                        id: d.id,
                        operator_id: d.operator_id,
                        cert_type_id: d.cert_type_id,
                        status: d.raw_status,
                        issue_date: d.issue_date,
                        expiry_date: d.expiry_date,
                        notes: d.notes,
                        file_path: d.file_path || null
                    });
                    if (d.status_calc === 'SCADUTA') tr.classList.add('table-danger');
                    if (d.status_calc && d.status_calc.startsWith('IN_SCADENZA')) tr.classList.add('table-warning');
                    $tb.append(tr);
                });
            }).fail(() => alert('Errore nel caricamento certificazioni'));
        }

        // ----------------- Modale: Modifica -----------------
        $('#certsTable').on('click', '.editCertBtn', function () {
            const r = $(this).closest('tr').data('row');

            $('#certRowId').val(r.id || '');
            $('#certOperatorId').val(r.operator_id || opId);
            $('#editCertForm [name="status"]').val(r.status || 'ND');
            $('#editCertForm [name="issue_date"]').val(r.issue_date || '');
            $('#editCertForm [name="expiry_date"]').val(r.expiry_date || '');
            $('#editCertForm [name="notes"]').val(r.notes || '');
            $('#certAttachment').val('');
            $('#currentFileInfo').text(r.file_path ? 'Allegato presente' : '');

            loadCertTypes(r.cert_type_id).then(() => {
                const modal = new bootstrap.Modal(document.getElementById('editCertModal'));
                modal.show();
                // azzera flag e ricalcola per sovrascrivere anche se c'è già una scadenza
                $('#editCertForm [name="expiry_date"]').data('touched', false);
                tryAutofillExpiry();
            });
        });

        // ----------------- Modale: Aggiungi (pulita) -----------------
        document.getElementById('editCertModal').addEventListener('show.bs.modal', function (ev) {
            if (ev.relatedTarget && ev.relatedTarget.matches('.btn-success')) {
                $('#editCertForm')[0].reset();
                $('#certRowId').val('');
                $('#certOperatorId').val(opId);
                $('#currentFileInfo').text('');
                $('#editCertForm [name="expiry_date"]').data('touched', false);
                loadCertTypes(null).then(() => tryAutofillExpiry());
            }
        });

        // cambia tipo/rilascio → azzera "touched" e ricalcola
        $('#certTypeSelect').on('change', resetExpiryTouchedAndRecompute);
        $('#editCertForm [name="issue_date"]').on('change', resetExpiryTouchedAndRecompute);

        // ----------------- Salva certificazione -----------------
        $('#saveCertBtn').on('click', function () {
            const fd = new FormData(document.getElementById('editCertForm'));
            if (!$('#certRowId').val()) fd.delete('id');
            $('#saveCertBtn').prop('disabled', true);
            $.ajax({
                url: '/api/hr/certs/upsert',
                type: 'POST',
                data: fd,
                processData: false,
                contentType: false
            })
                .done(function () {
                    bootstrap.Modal.getInstance(document.getElementById('editCertModal')).hide();
                    loadCerts();
                })
                .fail(function (xhr) {
                    alert('Errore salvataggio certificazione: ' + (xhr?.responseJSON?.detail || xhr?.responseText || ''));
                })
                .always(function () { $('#saveCertBtn').prop('disabled', false); });
        });

        // ----------------- Elimina certificazione -----------------
        $('#certsTable').on('click', '.deleteCertBtn', function () {
            const r = $(this).closest('tr').data('row');
            if (!r?.id) return;
            if (!confirm('Eliminare questa certificazione?')) return;
            $.post('/api/hr/certs/delete', { id: r.id })
                .done(loadCerts)
                .fail((xhr) => alert('Errore eliminazione certificazione: ' + (xhr?.responseJSON?.detail || xhr?.responseText || '')));
        });

        // ----------------- Init -----------------
        loadOperator();
        loadCerts();

        if (getParam('addCert') === '1') {
            loadCertTypes(null).then(() => {
                const modal = new bootstrap.Modal(document.getElementById('editCertModal'));
                modal.show();
                $('#editCertForm [name="expiry_date"]').data('touched', false);
                tryAutofillExpiry();
            });
        }
    })();
</script>

{% endblock %}